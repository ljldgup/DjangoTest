<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>交易汇总</title>
<link href="/static/jquery.dataTables.css" rel="stylesheet"
	type="text/css" />
<script type="text/javascript" src="/static/jquery-3.1.1.min.js"></script>
<script src="/static/jquery.dataTables.js" type="text/javascript"></script>
</head>
<body style="background: rgb(250, 250, 255)">

	<div style="width: 1400px">
		<div style="width: 1000px">
			<h1>个人交易汇总</h1>
			<form action="/trade_report/" method="get"
				style="float: left; width: 760px;">
				股票<input type="text" id="r_name" name="r_name"
					value="{{r_name | default_if_none:""}}" style="width: 100px;margin-left: 32px"> <br>
				开始时间<input type="date" id="st_date" name="st_date"
					value="{{st_date | default_if_none:"2017-01-01"}}"> <br>
				结束时间<input type="date" id="ed_date" name="ed_date"
					value="{{ed_date | default_if_none:""}}"> <input
					type="submit" value="提交">
			</form>

		</div>
	</div>
	<div style="width: 1300px">
		<div style="width: 950px; float: left;">
		
			<script>
				function getDate(obj)
				{
					var url = self.location.href;
					var url_param = url.split('?')[1];
					url_param = url_param.split('&');
					var params = '?' + url_param[1] + '&' + url_param[2];
					obj.href += params;
				}
			</script>
			<table id="stat_data" border="1">

				<thead>
					<tr>
						<th>股票</th>
						<th>最初买入日期</th>
						<th>最终卖出日期</th>
						<th>总买入金额</th>
						<th>总卖出金额</th>
						<th>总持股时间</th>
						<th>盈亏金额</th>
						<th>盈亏百分比</th>
					</tr>
				</thead>

				<tbody>
					{% for i in stat_data %}
					<tr>
						<td><a href="/trade_detail/{{i.code}}/" onclick="getDate(this)" target="_blank">{{i.name}}</a></td>
						<td>{{i.i_date|date:'Y-m-d'}}</td>
						<td>{{i.o_date|date:'Y-m-d'}}</td>
						<td>{{i.i_total}}</td>
						<td>{{i.o_total}}</td>
						<td>{{i.time}}</td> {% if i.earning >= 0 %}
						<td style="color: red">{{i.earning}}</td>
						<td style="color: red">{{i.pct}}</td> {% else %}
						<td style="color: green">{{i.earning}}</td>
						<td style="color: green">{{i.pct}}</td> {% endif %}

					</tr>
					{% endfor %}
				</tbody>
			</table>
			<script>
				$(document).ready( function () {
					$('#stat_data').DataTable();
				} );
			</script>
		</div>
		<div style="float: right; width: 300px; margin-left: 8px"
			id="stat_res">
			<h3>结果统计</h3>
			<script type="text/javascript">
				/** 
				 * 遍历表格内容进行统计
				 */
					var mytable = document.getElementById("stat_data");
					var data = {t_win_earning:0, t_los_earning:0, t_win_num:0, t_los_num:0, t_win_10_num:0, t_los_5_num:0, t_win_10_earning:0, t_los_5_earning:0};
					var tmp = 0;
					var pct = 0;
					
					for(var i=1, rows=mytable.rows.length; i<rows; i++){
					  tmp = parseFloat(mytable.rows[i].cells[6].innerHTML);
					  pct = parseFloat(mytable.rows[i].cells[7].innerHTML);
					  if(tmp > 0){
						data.t_win_earning += tmp;
						data.t_win_num += 1;
						if(pct > 10){
							data.t_win_10_earning += tmp;
							data.t_win_10_num += 1;
						}
					  }
					  else{
						data.t_los_earning += tmp;
						data.t_los_num += 1;
						if(pct < -5){
							data.t_los_5_earning += tmp;
							data.t_los_5_num += 1;
						}
					  }
					}
					
					t_rate = parseInt(data.t_win_num/(data.t_los_num + data.t_win_num)*1000)/10.0
					document.write("<p>总收益：" + data.t_win_earning + "</p>");
					document.write("<p>总亏损：" + data.t_los_earning + "</p>");
					document.write("<p>合计：" +  (data.t_win_earning + data.t_los_earning) + "</p>");
					document.write("<p>成功次数：" + data.t_win_num + "</p>");
					document.write("<p>失败次数：" + data.t_los_num + "</p>");
					document.write("<p>成功率：" + t_rate + "&#37</p>");
					document.write("<p>盈利大于10%的次数：" + data.t_win_10_num + "</p>");
					document.write("<p>盈利大于10%的总收益：" + data.t_win_10_earning + "</p>");
					document.write("<p>亏损大于5%的次数：" + data.t_los_5_num + "</p>");
					document.write("<p>亏损大于5%的总收益：" + data.t_los_5_earning + "</p>");
				</script>

		</div>
</body>

</html>
