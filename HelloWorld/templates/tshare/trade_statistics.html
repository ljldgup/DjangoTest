<!DOCTYPE html>
<html>
<head>
<title>交易统计</title>
<script type="text/javascript" src="/static/echarts.min.js"></script>
<script type="text/javascript" src="/static/jquery-3.1.1.min.js"></script>
</head>

<body>
	<!-- 为ECharts准备一个具备大小（宽高）的Dom -->
	
	<div style="width: 750px;height:100px;">
		<h1>个人交易汇总</h1>
		<form action="/trade_statistics/" method="get"
			style="float: left; width: 760px;">
			开始时间<input type="date" id="st_date" name="st_date"
				value="{{st_date | default_if_none:"2017-01-01"}}"> &nbsp;&nbsp;&nbsp;
			结束时间<input type="date" id="ed_date" name="ed_date"
				value="{{ed_date | default_if_none:""}}">  &nbsp;&nbsp;&nbsp;<input
				type="submit" value="提交">
		</form>
	</div>
		
	<div id="main" style="width: 1200px;height:1000px;">
		<div id="main1" style="width: 900px;height:300px;"></div>
		<div id="main2" style="width: 900px;height:300px;"></div>
	</div>
	<script type="text/javascript">
		$.ajaxSetup({async:false});

		var stat_data;
		var test;
		var json_url = "/trade_data_json/";
		var url = self.location.href;
		params = url.split("?");
		if (params.length > 1) {
			json_url += "?" + params[1];
		}
		
		$.getJSON(json_url, function(data){
			stat_data = data;
		});
		
		var x = x_axis_gen(stat_data);
		var rst1 = static_data_gen1(x,stat_data);
		$(document).ready( function () {

		});
		
		function static_data_gen1(x_axis, ori_data){
			var total_count = [];
			var win_count = [];
			var earning = [];
			var tmp_total,tmp_win,tmp_earning,st=0;
			for (var i = 0; i < x_axis.length; i++) {
				x_date = x_axis[i];
				tmp_total = tmp_win = tmp_earning = 0;
				for (; st < ori_data.length; st++) {
					//console.log(i);
					//console.log(st);
					//console.log(ori_data[st][3].substring(0,7));
					//console.log(x_axis[i])
					if(ori_data[st][3].substring(0,7) == x_axis[i]){
						tmp_total++;
						tmp_earning += ori_data[st][6];
						if(ori_data[st][6] > 0) tmp_win++;
					}
					if(ori_data[st][3].substring(0,7) > x_axis[i]) break;
				}
				total_count[i] = tmp_total;
				win_count[i] = tmp_win;
				earning[i] = tmp_earning;
				
			}
			return{
				total_count:total_count,
				win_count:win_count,
				earning:earning
			}
		}
		
		function x_axis_gen(data){

			var x_axis = [];
			var min_year = data[0][3].split("-")[0];
			var min_month = data[0][3].split("-")[1];
			var max_year = data[data.length-1][3].split("-")[0];
			var max_month = data[data.length-1][3].split("-")[1];
			
			var max_x = max_year + '-' + max_month
			var tmp_year = parseInt(min_year);
			var tmp_month = parseInt(min_month);
			
			if (tmp_month < 10) {
				tmp_x = tmp_year + '-0' + tmp_month;
			}
			else{
				tmp_x = tmp_year + '-' + tmp_month;
			}
		
			while(tmp_x <= max_x ){
				x_axis.push(tmp_x);
				if(tmp_month < 12){
					tmp_month+=1;
				}else{
					tmp_month = 1;
					tmp_year++;
				}
				if (tmp_month < 10) {
					tmp_x = tmp_year + '-0' + tmp_month;
				}
				else{
					tmp_x = tmp_year + '-' + tmp_month;
				}
			}
			return x_axis;
		}
		
		
		
				// 基于准备好的dom，初始化echarts实例
		var myChart1 = echarts.init(document.getElementById('main1'));
		var myChart2 = echarts.init(document.getElementById('main2'));
		// 指定图表的配置项和数据
		var option1 = {
		


			title: {
				text: '交易次数统计'
			},
			tooltip: {},
			legend: {
				data:['月份']
			},
			xAxis: {
				axisLabel: {
					interval:1,
					rotate:-90
				},
				minInterval: 100,
				data: x
			},
			yAxis: {},
			series: [{
				name: '总次数',
				type: 'bar',
				data: rst1.total_count,
				barWidth: 10, 
				itemStyle:{ 
					normal:{ 
					color:'#0000FF',
					label: {
						show: true, //开启显示
						position: 'top', //在上方显示
						textStyle: { //数值样式
							color: 'black',
							fontSize: 10
							}
						}
					}
				}
			},{
				name: '成功次数',
				type: 'bar',
				data: rst1.win_count,
				barWidth: 10, 
				itemStyle:{ 
					normal:{ 
					color:'#FF0000',
					label: {
						show: true, //开启显示
						position: 'top', //在上方显示
						textStyle: { //数值样式
							color: 'black',
							fontSize: 10
							}
						}
					}
				}
			}]
		};
		
		var option2 = {
			title: {
				text: '盈亏统计'
			},
			tooltip: {},
			legend: {
				data:['月份']
			},
			xAxis: {
				axisLabel: {
					interval:1,
					rotate:-90
				},
				data: x
			},
			yAxis: {},
			series: [{
				name: '总盈亏',
				type: 'bar',
				barWidth: 10, 
				itemStyle: {
					normal: {
						// 颜色
						color: function(params) { 
							if(params.data > 0) return '#FF0000';
							return '#00FF00'; 
						},
						
						label: {
							show: true, //开启显示
							position: 'top', //在上方显示
							textStyle: { //数值样式
								color: 'black',
								fontSize: 10
							}
						}
					},
				},
				data: rst1.earning
			}]
		};
		
		//使用json初始化
		myChart1.setOption(option1);
		myChart2.setOption(option2);
	</script>
</body>
</html>
